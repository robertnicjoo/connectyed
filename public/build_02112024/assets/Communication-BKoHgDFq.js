import{_ as M,M as S,x as g,e as a,f as r,i as _,n as y,F as k,z as f,t as d,k as w,L as v,g as T,m as x,o as i,q as D,s as A}from"./app-D0Fdxhbm.js";import{M as z,p as u,i as b,f as p}from"./Messaging-88m0BgJs.js";const C={name:"Communication",components:{Messaging:z},data(){return{currentTab:"schedule",matchmakers:[],selectedMatchmaker:null,selectedTimeSlot:null,clientMeetings:[],processing:!1,allTimeSlots:[],searchQuery:"",showDropdown:!1,duration:30,selectedClients:[],clients:[]}},computed:{...S({user:e=>e.auth.user,authorization:e=>e.auth.authorization}),isAuthenticated(){return!!this.authorization&&!!this.authorization.token},validTimeSlots(){return this.selectedMatchmaker&&this.selectedMatchmaker.availability.length?this.selectedMatchmaker.availability:[]},filteredClients(){const e=this.searchQuery.toLowerCase();return this.clients.filter(t=>t.name&&t.name.toLowerCase().includes(e)&&!this.selectedClients.find(n=>n.id===t.id))},minDateTime(){return new Date().toISOString().slice(0,16)}},watch:{isAuthenticated(e){e&&(this.fetchMatchmakers(),this.getUpcomingMeetings(),this.getClients())}},created(){const t=new URLSearchParams(window.location.search).get("token");t?(g.defaults.headers.common.Authorization=`Bearer ${t}`,g.get("/api/user/introspect",{headers:{Authorization:`Bearer ${t}`}}).then(n=>{const c={user:n.data.user,authorization:{token:t}};this.$store.dispatch("auth/setAuth",c),window.history.replaceState({},document.title,"/matchmaker/communication")}).catch(n=>{console.error("Error fetching user data:",n),alert("Failed to authenticate. Please log in again."),this.$router.push("/login")})):this.$store.dispatch("auth/initialize")},mounted(){this.isAuthenticated&&(this.fetchMatchmakers(),this.getUpcomingMeetings(),this.getClients()),console.log("User:",this.user),console.log("Authorization:",this.authorization)},methods:{connectGoogle(){window.location.href="/api/google/redirect"},async getUpcomingMeetings(){if(this.isAuthenticated)try{const e=await g.get("/api/google/upcoming-meetings",{headers:{Authorization:`Bearer ${this.authorization.token}`}});e.data.success?(this.clientMeetings=e.data.data,console.log("Upcoming Meetings:",this.clientMeetings)):(console.error("Failed to fetch upcoming meetings:",e.data.message),alert("Failed to fetch upcoming meetings. Please try again later."))}catch(e){console.error("Error fetching upcoming meetings:",e),alert("An error occurred while fetching upcoming meetings.")}},async revokeGoogle(){try{const e=await g.post("/api/google/revoke-token",{},{headers:{Authorization:`Bearer ${this.authorization.token}`}});e.data.success?(alert(e.data.message),this.$store.dispatch("auth/logout")):alert(e.data.message||"Failed to revoke Google account.")}catch(e){console.error("Error revoking Google account:",e),alert("An error occurred while revoking your Google account.")}},async fetchMatchmakers(){if(this.isAuthenticated){this.processing=!0;try{const e=await g.get("/api/matchmakers",{headers:{Authorization:`Bearer ${this.authorization.token}`}});e.data.success?(this.matchmakers=e.data.data,console.log("Matchmakers:",this.matchmakers)):(console.error("Failed to fetch matchmakers:",e.data.message),alert("Failed to fetch matchmakers. Please try again later."))}catch(e){console.error("Error fetching matchmakers:",e),alert("An error occurred while fetching matchmakers.")}finally{this.processing=!1}}},selectMatchmaker(e){this.selectedMatchmaker=e,this.selectedTimeSlot=null,this.prepareAllTimeSlots()},prepareAllTimeSlots(){this.allTimeSlots=[],this.validTimeSlots.forEach(e=>{const t=u(e.start_date),n=u(e.end_date);if(!b(t)||!b(n)||t>n){console.warn(`Invalid date range for availability ID ${e.id}. Skipping.`);return}let c=new Date(t);for(;c<=n;){const s=p(c,"yyyy-MM-dd"),l=p(c,"EEEE, MMMM d, yyyy");if(e.is_all_day)this.allTimeSlots.push({id:`${e.id}-${s}-all-day`,display:`${l} - All Day`,day:s,slot:null,duration:1440,start_time:null,end_time:null});else{const m=p(u(`${s}T${e.start_time}`),"hh:mm a"),o=p(u(`${s}T${e.end_time}`),"hh:mm a");this.allTimeSlots.push({id:`${e.id}-${s}-${e.start_time}-${e.end_time}`,display:`${l} - ${m} to ${o}`,day:s,slot:{start:u(`${s}T${e.start_time}`),end:u(`${s}T${e.end_time}`)},duration:this.calculateDuration(e.start_time,e.end_time),start_time:e.start_time,end_time:e.end_time})}c.setDate(c.getDate()+1)}}),this.allTimeSlots.sort((e,t)=>{const n=new Date(e.day),c=new Date(t.day);return n<c?-1:n>c?1:e.slot&&t.slot?e.slot.start-t.slot.start:e.slot?-1:t.slot?1:0})},calculateDuration(e,t){const[n,c]=e.split(":").map(Number),[s,l]=t.split(":").map(Number),m=new Date;m.setHours(n,c,0,0);const o=new Date;return o.setHours(s,l,0,0),(o-m)/6e4},async proceedToPayment(){if(!this.selectedMatchmaker||!this.selectedTimeSlot){alert("Please select a matchmaker and a time slot before proceeding to payment.");return}const e=this.selectedTimeSlot;let t,n;e.slot?(t=e.slot.start.toISOString(),n=e.duration):(t=new Date(`${e.day}T00:00:00`).toISOString(),n=1440),this.processing=!0;try{console.log("Creating checkout session with the following data:"),console.log("Matchmaker ID:",this.selectedMatchmaker.id),console.log("Start Time:",t),console.log("Duration:",n);const c=await g.post("/api/google/create-meeting",{matchmaker_id:this.selectedMatchmaker.id,client_ids:[this.user.id],start_time:t,duration:n},{headers:{Authorization:`Bearer ${this.authorization.token}`}});if(c.data.success){const{payment_link:s}=c.data.data;alert("🔗 Redirecting to payment..."),window.location.href=s}else console.error("Failed to create checkout session:",c.data.message),alert(`Error: ${c.data.message||"Failed to create checkout session."}`)}catch(c){console.error("Error creating checkout session:",c),alert("An error occurred while creating the checkout session.")}finally{this.processing=!1}},formatDate(e){return p(u(e),"EEEE, MMMM d, yyyy h:mm a")}}},h=e=>(D("data-v-f4822cde"),e=e(),A(),e),E={class:"container mx-auto p-4"},P={key:0},G={key:0,class:"mb-4"},I={key:0},U=h(()=>r("p",{class:"text-green-500"},"✅ Google Account Connected",-1)),B={key:1},F=h(()=>r("p",{class:"text-red-500"},"❌ Google Account Not Connected",-1)),N={class:"tabs mb-6"},L={key:1},$={class:"mb-6"},O=h(()=>r("h3",{class:"text-lg font-semibold mb-2"},"Select a Matchmaker",-1)),V={key:0,class:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"},H={class:"font-bold text-md mb-1"},q={class:"text-sm text-gray-600 mb-2"},Q=["onClick","disabled"],R={key:1,class:"text-gray-600"},J={key:0,class:"mb-6"},j={class:"text-lg font-semibold mb-2"},K={key:0,class:"space-y-4"},W={class:"bg-gray-50 p-4 rounded-lg shadow"},X=h(()=>r("label",{class:"block text-gray-700 font-bold mb-2",for:"timeSlot"},"Select a Time Slot:",-1)),Y=h(()=>r("option",{disabled:"",value:""},"Please select a time slot",-1)),Z=["value"],ee={key:1,class:"text-gray-600"},te={key:1,class:"mb-6"},se=h(()=>r("h3",{class:"text-lg font-semibold mb-2"},"Proceed to Payment",-1)),oe=["disabled"],re={key:2},ae=h(()=>r("h2",{class:"text-xl font-semibold mb-4"},"Upcoming Meetings",-1)),ie={key:0,class:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"},ne={class:"text-lg font-bold mb-2"},ce={class:"text-gray-700"},le={class:"text-gray-700"},de={key:0,class:"mt-4"},he=["href"],ue={class:"mt-4"},me=h(()=>r("h4",{class:"font-semibold mb-1"},"Matchmaker:",-1)),ge={key:1,class:"text-gray-600"},_e={class:"mt-8"},pe={key:1,class:"text-center py-10"},ke=h(()=>r("p",null,"Loading...",-1)),fe=[ke];function ye(e,t,n,c,s,l){const m=x("Messaging");return i(),a("div",E,[l.isAuthenticated?(i(),a("div",P,[e.user.role==="client"?(i(),a("div",G,[e.user.google_access_token?(i(),a("div",I,[U,r("button",{onClick:t[0]||(t[0]=(...o)=>l.revokeGoogle&&l.revokeGoogle(...o)),class:"py-2 px-4 bg-red-500 text-white rounded hover:bg-red-600"}," Disconnect Google Account ")])):(i(),a("div",B,[F,r("button",{onClick:t[1]||(t[1]=(...o)=>l.connectGoogle&&l.connectGoogle(...o)),class:"py-2 px-4 bg-blue-500 text-white rounded hover:bg-blue-600"}," Connect Google Account ")]))])):_("",!0),r("div",N,[r("button",{onClick:t[2]||(t[2]=o=>s.currentTab="schedule"),class:y([{active:s.currentTab==="schedule"},"tab-button"])}," Schedule a Meeting ",2),r("button",{onClick:t[3]||(t[3]=o=>s.currentTab="upcoming"),class:y([{active:s.currentTab==="upcoming"},"tab-button"])}," Upcoming Meetings ",2)]),s.currentTab==="schedule"?(i(),a("div",L,[r("div",$,[O,s.matchmakers.length?(i(),a("div",V,[(i(!0),a(k,null,f(s.matchmakers,o=>(i(),a("div",{key:o.id,class:"bg-gray-100 p-4 rounded-lg shadow hover:bg-gray-200 transition duration-200"},[r("h4",H,d(o.name),1),r("p",q,d(o.email),1),r("button",{onClick:be=>l.selectMatchmaker(o),disabled:s.selectedMatchmaker&&s.selectedMatchmaker.id===o.id,class:"w-full py-2 px-4 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-blue-300 transition duration-200"},d(s.selectedMatchmaker&&s.selectedMatchmaker.id===o.id?"Selected":"Select"),9,Q)]))),128))])):(i(),a("div",R,"No matchmakers available at the moment."))]),s.selectedMatchmaker?(i(),a("div",J,[r("h3",j,"Available Time Slots for "+d(s.selectedMatchmaker.name),1),s.allTimeSlots.length?(i(),a("div",K,[r("div",W,[X,w(r("select",{id:"timeSlot","onUpdate:modelValue":t[4]||(t[4]=o=>s.selectedTimeSlot=o),class:"w-full border border-gray-300 rounded p-2",required:""},[Y,(i(!0),a(k,null,f(s.allTimeSlots,o=>(i(),a("option",{key:o.id,value:o},d(o.display),9,Z))),128))],512),[[v,s.selectedTimeSlot]])])])):(i(),a("div",ee,"No available time slots for this matchmaker."))])):_("",!0),s.selectedTimeSlot?(i(),a("div",te,[se,r("button",{onClick:t[5]||(t[5]=(...o)=>l.proceedToPayment&&l.proceedToPayment(...o)),class:"w-full py-2 px-4 bg-purple-500 text-white rounded hover:bg-purple-600 transition duration-200",disabled:s.processing},d(s.processing?"Processing...":"Pay and Schedule Meeting"),9,oe)])):_("",!0)])):_("",!0),s.currentTab==="upcoming"?(i(),a("div",re,[ae,s.clientMeetings.length?(i(),a("div",ie,[(i(!0),a(k,null,f(s.clientMeetings,o=>(i(),a("div",{key:o.id,class:"bg-white rounded-lg shadow-md p-6"},[r("h3",ne,"Meeting ID: "+d(o.google_meet_id),1),r("p",ce,"Start Time: "+d(l.formatDate(o.start_time)),1),r("p",le,"Duration: "+d(o.duration)+" minutes",1),o.google_meet_link?(i(),a("div",de,[r("a",{href:o.google_meet_link,target:"_blank",rel:"noopener noreferrer",class:"text-blue-600 hover:text-blue-800 underline"}," Join Google Meet ",8,he)])):_("",!0),r("div",ue,[me,r("p",null,d(o.matchmaker.name)+" ("+d(o.matchmaker.email)+")",1)])]))),128))])):(i(),a("div",ge,"No upcoming meetings found."))])):_("",!0),r("div",_e,[T(m,{currentUser:e.user,authorization:e.authorization},null,8,["currentUser","authorization"])])])):(i(),a("div",pe,fe))])}const we=M(C,[["render",ye],["__scopeId","data-v-f4822cde"]]);export{we as default};
